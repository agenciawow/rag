# manage_production_users.py

import json
import hashlib
from datetime import datetime
from pathlib import Path
import sys
import shutil

class ProductionUserManager:
    """Gerenciador de usu√°rios para o sistema RAG de produ√ß√£o"""
    
    def __init__(self, users_file="production_users.json"):
        self.users_file = Path(users_file)
        self.users = self.load_users()
        self.salt = "streamlit_rag_production_2025"  # Mesmo salt da vers√£o de produ√ß√£o
        
        # Permiss√µes dispon√≠veis
        self.available_permissions = [
            "extract",      # Extra√ß√£o de dados
            "stats",        # Estat√≠sticas do sistema
            "clear_all",    # Limpar dados de outros usu√°rios
            "manage_users", # Gerenciar outros usu√°rios
            "admin"         # Acesso administrativo completo
        ]
        
        # Perfis pr√©-definidos com permiss√µes
        self.role_permissions = {
            "Admin": ["extract", "stats", "clear_all", "manage_users", "admin"],
            "Pesquisador": ["extract", "stats"],
            "Demonstra√ß√£o": [],
            "Estudante": ["extract"],
            "Professor": ["extract", "stats"],
            "Convidado": []
        }
    
    def load_users(self):
        """Carrega usu√°rios do arquivo"""
        if self.users_file.exists():
            try:
                with open(self.users_file, 'r', encoding='utf-8') as f:
                    return json.load(f)
            except Exception as e:
                print(f"‚ùå Erro ao carregar usu√°rios: {e}")
                return {}
        return {}
    
    def save_users(self):
        """Salva usu√°rios no arquivo"""
        try:
            # Backup do arquivo atual
            if self.users_file.exists():
                backup_file = self.users_file.with_suffix('.json.backup')
                shutil.copy2(self.users_file, backup_file)
            
            with open(self.users_file, 'w', encoding='utf-8') as f:
                json.dump(self.users, f, indent=2, ensure_ascii=False)
            return True
        except Exception as e:
            print(f"‚ùå Erro ao salvar usu√°rios: {e}")
            return False
    
    def hash_password(self, password: str) -> str:
        """Cria hash da senha com salt (compat√≠vel com produ√ß√£o)"""
        return hashlib.sha256((password + self.salt).encode()).hexdigest()
    
    def add_user(self, username: str, name: str, password: str, role: str = "Pesquisador", 
                 organization: str = "", custom_permissions: list = None):
        """Adiciona novo usu√°rio"""
        if username in self.users:
            return False, "Usu√°rio j√° existe!"
        
        if len(username) < 3:
            return False, "Nome de usu√°rio deve ter pelo menos 3 caracteres!"
        
        if len(password) < 4:
            return False, "Senha deve ter pelo menos 4 caracteres!"
        
        # Define permiss√µes baseadas no perfil ou customizadas
        if custom_permissions is not None:
            permissions = [p for p in custom_permissions if p in self.available_permissions]
        else:
            permissions = self.role_permissions.get(role, [])
        
        self.users[username] = {
            "password_hash": self.hash_password(password),
            "name": name,
            "role": role,
            "organization": organization,
            "permissions": permissions,
            "created_at": datetime.now().isoformat(),
            "last_login": "",
            "total_conversations": 0,
            "successful_queries": 0,
            "failed_queries": 0,
            "extractions_count": 0,
            "active": True,
            "notes": ""
        }
        
        if self.save_users():
            return True, f"Usu√°rio '{username}' criado com sucesso!"
        else:
            return False, "Erro ao salvar usu√°rio!"
    
    def update_user(self, username: str, **kwargs):
        """Atualiza informa√ß√µes do usu√°rio"""
        if username not in self.users:
            return False, "Usu√°rio n√£o encontrado!"
        
        # Campos que podem ser atualizados
        allowed_fields = ['name', 'role', 'organization', 'active', 'notes']
        
        for field, value in kwargs.items():
            if field in allowed_fields:
                self.users[username][field] = value
            elif field == 'password':
                self.users[username]['password_hash'] = self.hash_password(value)
            elif field == 'permissions':
                # Valida permiss√µes
                valid_permissions = [p for p in value if p in self.available_permissions]
                self.users[username]['permissions'] = valid_permissions
            elif field == 'role':
                # Atualiza permiss√µes baseadas no novo perfil
                self.users[username]['role'] = value
                if value in self.role_permissions:
                    self.users[username]['permissions'] = self.role_permissions[value]
        
        self.users[username]['updated_at'] = datetime.now().isoformat()
        
        if self.save_users():
            return True, f"Usu√°rio '{username}' atualizado com sucesso!"
        else:
            return False, "Erro ao atualizar usu√°rio!"
    
    def remove_user(self, username: str):
        """Remove usu√°rio"""
        if username not in self.users:
            return False, "Usu√°rio n√£o encontrado!"
        
        # N√£o permite remover se for o √∫ltimo admin
        if self.users[username].get('role') == 'Admin':
            admin_count = sum(1 for user in self.users.values() 
                            if user.get('role') == 'Admin' and user.get('active', True))
            if admin_count <= 1:
                return False, "N√£o √© poss√≠vel remover o √∫ltimo administrador!"
        
        del self.users[username]
        
        if self.save_users():
            # Remove tamb√©m os dados do usu√°rio
            user_dir = Path(f"production_users/{username}")
            if user_dir.exists():
                try:
                    shutil.rmtree(user_dir)
                    print(f"üìÅ Dados do usu√°rio removidos: {user_dir}")
                except Exception as e:
                    print(f"‚ö†Ô∏è Erro ao remover dados: {e}")
            
            return True, f"Usu√°rio '{username}' removido com sucesso!"
        else:
            return False, "Erro ao remover usu√°rio!"
    
    def list_users(self, show_inactive=False):
        """Lista todos os usu√°rios"""
        if not self.users:
            print("üìã Nenhum usu√°rio cadastrado.")
            return
        
        users_to_show = self.users
        if not show_inactive:
            users_to_show = {k: v for k, v in self.users.items() if v.get('active', True)}
        
        print("üìã USU√ÅRIOS CADASTRADOS (SISTEMA DE PRODU√á√ÉO):")
        print("=" * 100)
        print(f"{'Username':<15} {'Nome':<25} {'Perfil':<15} {'Organiza√ß√£o':<20} {'Permiss√µes':<15} {'Status':<8}")
        print("-" * 100)
        
        for username, info in users_to_show.items():
            status = "Ativo" if info.get('active', True) else "Inativo"
            permissions_str = str(len(info.get('permissions', [])))
            org = info.get('organization', 'N/A')[:19]  # Trunca se muito longo
            
            print(f"{username:<15} {info['name']:<25} {info['role']:<15} {org:<20} {permissions_str:<15} {status:<8}")
        
        total_shown = len(users_to_show)
        total_all = len(self.users)
        
        if show_inactive:
            print(f"\nTotal: {total_all} usu√°rios")
        else:
            print(f"\nAtivos: {total_shown} | Total: {total_all} usu√°rios")
            if total_all > total_shown:
                print("üí° Use --include-inactive para ver usu√°rios inativos")
    
    def get_user_details(self, username: str):
        """Mostra detalhes de um usu√°rio espec√≠fico"""
        if username not in self.users:
            print(f"‚ùå Usu√°rio '{username}' n√£o encontrado!")
            return
        
        user = self.users[username]
        print(f"\nüë§ DETALHES DO USU√ÅRIO: {username}")
        print("=" * 60)
        print(f"Nome: {user['name']}")
        print(f"Perfil: {user['role']}")
        print(f"Organiza√ß√£o: {user.get('organization', 'N/A')}")
        print(f"Status: {'Ativo' if user.get('active', True) else 'Inativo'}")
        print(f"Criado em: {user['created_at']}")
        print(f"√öltimo login: {user.get('last_login', 'Nunca')}")
        
        # Permiss√µes
        permissions = user.get('permissions', [])
        print(f"Permiss√µes ({len(permissions)}): {', '.join(permissions) if permissions else 'Nenhuma'}")
        
        # Estat√≠sticas de uso
        print(f"\nüìä Estat√≠sticas de Uso:")
        print(f"  Conversas totais: {user.get('total_conversations', 0)}")
        print(f"  Consultas bem-sucedidas: {user.get('successful_queries', 0)}")
        print(f"  Consultas falhadas: {user.get('failed_queries', 0)}")
        print(f"  Extra√ß√µes realizadas: {user.get('extractions_count', 0)}")
        
        # Taxa de sucesso
        total_queries = user.get('successful_queries', 0) + user.get('failed_queries', 0)
        if total_queries > 0:
            success_rate = (user.get('successful_queries', 0) / total_queries) * 100
            print(f"  Taxa de sucesso: {success_rate:.1f}%")
        
        # Notas
        if user.get('notes'):
            print(f"\nüìù Notas: {user['notes']}")
        
        # Verifica dados salvos
        user_dir = Path(f"production_users/{username}")
        if user_dir.exists():
            memory_file = user_dir / "chat_history.json"
            stats_file = user_dir / "user_stats.json"
            
            print(f"\nüíæ Dados Salvos:")
            
            if memory_file.exists():
                try:
                    with open(memory_file, 'r') as f:
                        data = json.load(f)
                        print(f"  Hist√≥rico: {data.get('total_messages', 0)} mensagens")
                        print(f"  √öltima atualiza√ß√£o: {data.get('last_updated', 'N/A')}")
                except:
                    print("  Hist√≥rico: Erro ao ler")
            else:
                print("  Hist√≥rico: Nenhum")
            
            if stats_file.exists():
                try:
                    with open(stats_file, 'r') as f:
                        stats = json.load(f)
                        print(f"  Primeira atividade: {stats.get('first_login', 'N/A')}")
                        print(f"  √öltima atividade: {stats.get('last_activity', 'N/A')}")
                except:
                    print("  Estat√≠sticas: Erro ao ler")
        else:
            print(f"\nüíæ Dados Salvos: Nenhum")

def show_menu():
    """Mostra menu principal"""
    print("\nüöÄ GERENCIADOR DE USU√ÅRIOS - SISTEMA RAG PRODU√á√ÉO")
    print("=" * 60)
    print("1. üë§ Adicionar usu√°rio")
    print("2. üìã Listar usu√°rios")
    print("3. üîç Detalhes do usu√°rio")
    print("4. ‚úèÔ∏è  Editar usu√°rio")
    print("5. üîí Alterar senha")
    print("6. üîë Gerenciar permiss√µes")
    print("7. ‚ùå Remover usu√°rio")
    print("8. üìä Estat√≠sticas")
    print("9. üîß Ferramentas")
    print("10. üö™ Sair")
    print("-" * 60)

def add_user_interactive(manager):
    """Adiciona usu√°rio interativamente"""
    print("\nüë§ ADICIONAR NOVO USU√ÅRIO")
    print("-" * 40)
    
    username = input("Username (login): ").strip()
    name = input("Nome completo: ").strip()
    password = input("Senha: ").strip()
    
    print(f"\nPerfis dispon√≠veis:")
    roles = list(manager.role_permissions.keys())
    for i, role in enumerate(roles, 1):
        perms = manager.role_permissions[role]
        print(f"{i}. {role} ({len(perms)} permiss√µes)")
    
    role_choice = input(f"Escolha o perfil (1-{len(roles)}): ").strip()
    try:
        role = roles[int(role_choice) - 1]
    except (ValueError, IndexError):
        role = "Pesquisador"
        print(f"‚ö†Ô∏è Op√ß√£o inv√°lida, usando perfil padr√£o: {role}")
    
    organization = input("Organiza√ß√£o (opcional): ").strip()
    
    # Op√ß√£o de personalizar permiss√µes
    custom_perms = input("\nPersonalizar permiss√µes? (s/n): ").strip().lower()
    permissions = None
    
    if custom_perms == 's':
        print(f"\nPermiss√µes dispon√≠veis:")
        for i, perm in enumerate(manager.available_permissions, 1):
            print(f"{i}. {perm}")
        
        perm_input = input("Digite os n√∫meros das permiss√µes (ex: 1,3,5): ").strip()
        if perm_input:
            try:
                perm_indices = [int(x.strip()) - 1 for x in perm_input.split(',')]
                permissions = [manager.available_permissions[i] for i in perm_indices 
                             if 0 <= i < len(manager.available_permissions)]
            except:
                print("‚ö†Ô∏è Formato inv√°lido, usando permiss√µes do perfil")
    
    success, message = manager.add_user(username, name, password, role, organization, permissions)
    
    if success:
        print(f"‚úÖ {message}")
        
        # Mostra resumo do usu√°rio criado
        user = manager.users[username]
        print(f"\nüìã Resumo do usu√°rio criado:")
        print(f"  Username: {username}")
        print(f"  Nome: {name}")
        print(f"  Perfil: {role}")
        print(f"  Permiss√µes: {', '.join(user['permissions']) if user['permissions'] else 'Nenhuma'}")
    else:
        print(f"‚ùå {message}")

def edit_user_interactive(manager):
    """Edita usu√°rio interativamente"""
    print("\n‚úèÔ∏è EDITAR USU√ÅRIO")
    print("-" * 30)
    
    username = input("Username para editar: ").strip()
    
    if username not in manager.users:
        print("‚ùå Usu√°rio n√£o encontrado!")
        return
    
    user = manager.users[username]
    print(f"\nDados atuais de '{username}':")
    print(f"Nome: {user['name']}")
    print(f"Perfil: {user['role']}")
    print(f"Organiza√ß√£o: {user.get('organization', 'N/A')}")
    print(f"Status: {'Ativo' if user.get('active', True) else 'Inativo'}")
    print(f"Permiss√µes: {', '.join(user.get('permissions', []))}")
    print(f"Notas: {user.get('notes', 'Nenhuma')}")
    
    print("\nDeixe em branco para manter o valor atual:")
    
    new_name = input(f"Novo nome [{user['name']}]: ").strip()
    
    # Perfis
    print(f"\nPerfis dispon√≠veis:")
    roles = list(manager.role_permissions.keys())
    for i, role in enumerate(roles, 1):
        print(f"{i}. {role}")
    
    current_role_idx = roles.index(user['role']) + 1 if user['role'] in roles else 0
    new_role_input = input(f"Novo perfil [{current_role_idx}={user['role']}]: ").strip()
    
    new_org = input(f"Nova organiza√ß√£o [{user.get('organization', 'N/A')}]: ").strip()
    
    new_notes = input(f"Novas notas [{user.get('notes', 'Nenhuma')}]: ").strip()
    
    status_input = input("Ativo? (s/n) [atual: {}]: ".format('s' if user.get('active', True) else 'n')).strip().lower()
    
    # Prepara atualiza√ß√µes
    updates = {}
    
    if new_name:
        updates['name'] = new_name
    
    if new_role_input:
        try:
            role_idx = int(new_role_input) - 1
            if 0 <= role_idx < len(roles):
                updates['role'] = roles[role_idx]
        except ValueError:
            pass
    
    if new_org:
        updates['organization'] = new_org
    
    if new_notes:
        updates['notes'] = new_notes
    
    if status_input in ['s', 'n']:
        updates['active'] = status_input == 's'
    
    if updates:
        success, message = manager.update_user(username, **updates)
        print(f"‚úÖ {message}" if success else f"‚ùå {message}")
    else:
        print("‚ÑπÔ∏è Nenhuma altera√ß√£o feita.")

def manage_permissions_interactive(manager):
    """Gerencia permiss√µes do usu√°rio"""
    print("\nüîë GERENCIAR PERMISS√ïES")
    print("-" * 30)
    
    username = input("Username: ").strip()
    
    if username not in manager.users:
        print("‚ùå Usu√°rio n√£o encontrado!")
        return
    
    user = manager.users[username]
    current_perms = user.get('permissions', [])
    
    print(f"\nPermiss√µes atuais de '{username}':")
    if current_perms:
        for i, perm in enumerate(current_perms, 1):
            print(f"  {i}. {perm}")
    else:
        print("  Nenhuma permiss√£o")
    
    print(f"\nPermiss√µes dispon√≠veis:")
    for i, perm in enumerate(manager.available_permissions, 1):
        status = "‚úì" if perm in current_perms else " "
        print(f"  {i}. [{status}] {perm}")
    
    print(f"\nOp√ß√µes:")
    print("1. Adicionar permiss√µes")
    print("2. Remover permiss√µes")
    print("3. Definir permiss√µes do perfil")
    print("4. Limpar todas as permiss√µes")
    
    choice = input("Escolha (1-4): ").strip()
    
    if choice == "1":
        # Adicionar
        available = [p for p in manager.available_permissions if p not in current_perms]
        if not available:
            print("‚úÖ Usu√°rio j√° tem todas as permiss√µes!")
            return
        
        print("Permiss√µes para adicionar:")
        for i, perm in enumerate(available, 1):
            print(f"  {i}. {perm}")
        
        selections = input("Digite os n√∫meros (ex: 1,3): ").strip()
        try:
            indices = [int(x.strip()) - 1 for x in selections.split(',')]
            to_add = [available[i] for i in indices if 0 <= i < len(available)]
            new_perms = current_perms + to_add
        except:
            print("‚ùå Formato inv√°lido!")
            return
    
    elif choice == "2":
        # Remover
        if not current_perms:
            print("‚ÑπÔ∏è Usu√°rio n√£o tem permiss√µes para remover!")
            return
        
        selections = input("Digite os n√∫meros para remover (ex: 1,3): ").strip()
        try:
            indices = [int(x.strip()) - 1 for x in selections.split(',')]
            to_remove = [current_perms[i] for i in indices if 0 <= i < len(current_perms)]
            new_perms = [p for p in current_perms if p not in to_remove]
        except:
            print("‚ùå Formato inv√°lido!")
            return
    
    elif choice == "3":
        # Usar permiss√µes do perfil
        role = user['role']
        new_perms = manager.role_permissions.get(role, [])
        print(f"Aplicando permiss√µes do perfil '{role}': {', '.join(new_perms) if new_perms else 'Nenhuma'}")
    
    elif choice == "4":
        # Limpar todas
        new_perms = []
        print("Removendo todas as permiss√µes...")
    
    else:
        print("‚ùå Op√ß√£o inv√°lida!")
        return
    
    success, message = manager.update_user(username, permissions=new_perms)
    print(f"‚úÖ {message}" if success else f"‚ùå {message}")

def change_password_interactive(manager):
    """Altera senha do usu√°rio"""
    print("\nüîí ALTERAR SENHA")
    print("-" * 20)
    
    username = input("Username: ").strip()
    
    if username not in manager.users:
        print("‚ùå Usu√°rio n√£o encontrado!")
        return
    
    print(f"Alterando senha para: {manager.users[username]['name']}")
    new_password = input("Nova senha: ").strip()
    
    if len(new_password) < 4:
        print("‚ùå Senha deve ter pelo menos 4 caracteres!")
        return
    
    confirm_password = input("Confirme a nova senha: ").strip()
    
    if new_password != confirm_password:
        print("‚ùå Senhas n√£o coincidem!")
        return
    
    success, message = manager.update_user(username, password=new_password)
    print(f"‚úÖ {message}" if success else f"‚ùå {message}")

def show_statistics(manager):
    """Mostra estat√≠sticas do sistema"""
    print("\nüìä ESTAT√çSTICAS DO SISTEMA DE PRODU√á√ÉO")
    print("=" * 50)
    
    if not manager.users:
        print("Nenhum usu√°rio cadastrado.")
        return
    
    total_users = len(manager.users)
    active_users = sum(1 for user in manager.users.values() if user.get('active', True))
    
    # Conta por perfil
    roles = {}
    permissions_count = {}
    for user in manager.users.values():
        role = user['role']
        roles[role] = roles.get(role, 0) + 1
        
        for perm in user.get('permissions', []):
            permissions_count[perm] = permissions_count.get(perm, 0) + 1
    
    print(f"üìà Usu√°rios:")
    print(f"  Total: {total_users}")
    print(f"  Ativos: {active_users}")
    print(f"  Inativos: {total_users - active_users}")
    
    print(f"\nüë• Por perfil:")
    for role, count in sorted(roles.items()):
        print(f"  {role}: {count}")
    
    print(f"\nüîë Permiss√µes mais usadas:")
    for perm, count in sorted(permissions_count.items(), key=lambda x: x[1], reverse=True):
        print(f"  {perm}: {count} usu√°rios")
    
    # Estat√≠sticas de uso
    total_conversations = sum(u.get('total_conversations', 0) for u in manager.users.values())
    total_extractions = sum(u.get('extractions_count', 0) for u in manager.users.values())
    
    print(f"\nüí¨ Uso do sistema:")
    print(f"  Total de conversas: {total_conversations}")
    print(f"  Total de extra√ß√µes: {total_extractions}")
    
    # Verifica diret√≥rios de usu√°rios
    users_with_data = 0
    total_messages = 0
    
    for username in manager.users:
        user_dir = Path(f"production_users/{username}")
        if user_dir.exists():
            memory_file = user_dir / "chat_history.json"
            if memory_file.exists():
                users_with_data += 1
                try:
                    with open(memory_file, 'r') as f:
                        data = json.load(f)
                        total_messages += data.get('total_messages', 0)
                except:
                    pass
    
    print(f"\nüíæ Dados salvos:")
    print(f"  Usu√°rios com dados: {users_with_data}")
    print(f"  Total de mensagens: {total_messages}")
    
    # Usu√°rios mais ativos
    if total_conversations > 0:
        print(f"\nüèÜ Usu√°rios mais ativos:")
        active_users_list = [(username, user.get('total_conversations', 0)) 
                           for username, user in manager.users.items() 
                           if user.get('total_conversations', 0) > 0]
        active_users_list.sort(key=lambda x: x[1], reverse=True)
        
        for username, conversations in active_users_list[:5]:
            print(f"  {username}: {conversations} conversas")

def tools_menu(manager):
    """Menu de ferramentas"""
    print("\nüîß FERRAMENTAS")
    print("-" * 20)
    print("1. Backup dos usu√°rios")
    print("2. Limpar dados de usu√°rio")
    print("3. Resetar estat√≠sticas")
    print("4. Migrar da vers√£o antiga")
    print("5. Voltar")
    
    choice = input("Escolha (1-5): ").strip()
    
    if choice == "1":
        # Backup
        backup_file = f"production_users_backup_{datetime.now().strftime('%Y%m%d_%H%M%S')}.json"
        try:
            shutil.copy2(manager.users_file, backup_file)
            print(f"‚úÖ Backup criado: {backup_file}")
        except Exception as e:
            print(f"‚ùå Erro no backup: {e}")
    
    elif choice == "2":
        # Limpar dados de usu√°rio
        username = input("Username para limpar dados: ").strip()
        if username not in manager.users:
            print("‚ùå Usu√°rio n√£o encontrado!")
            return
        
        confirm = input(f"‚ö†Ô∏è Confirma limpeza dos dados de '{username}'? (CONFIRMAR): ").strip()
        if confirm == "CONFIRMAR":
            user_dir = Path(f"production_users/{username}")
            if user_dir.exists():
                try:
                    shutil.rmtree(user_dir)
                    print(f"‚úÖ Dados removidos: {user_dir}")
                except Exception as e:
                    print(f"‚ùå Erro: {e}")
            else:
                print("‚ÑπÔ∏è Usu√°rio n√£o possui dados salvos")
    
    elif choice == "3":
        # Resetar estat√≠sticas
        username = input("Username para resetar estat√≠sticas (ou 'todos'): ").strip()
        
        if username == "todos":
            confirm = input("‚ö†Ô∏è Resetar estat√≠sticas de TODOS os usu√°rios? (CONFIRMAR): ").strip()
            if confirm == "CONFIRMAR":
                for user in manager.users.values():
                    user['total_conversations'] = 0
                    user['successful_queries'] = 0
                    user['failed_queries'] = 0
                    user['extractions_count'] = 0
                
                if manager.save_users():
                    print("‚úÖ Estat√≠sticas resetadas para todos os usu√°rios!")
                else:
                    print("‚ùå Erro ao salvar!")
        
        elif username in manager.users:
            manager.users[username].update({
                'total_conversations': 0,
                'successful_queries': 0,
                'failed_queries': 0,
                'extractions_count': 0
            })
            
            if manager.save_users():
                print(f"‚úÖ Estat√≠sticas resetadas para '{username}'!")
            else:
                print("‚ùå Erro ao salvar!")
        else:
            print("‚ùå Usu√°rio n√£o encontrado!")
    
    elif choice == "4":
        # Migra√ß√£o da vers√£o antiga
        old_file = "streamlit_users.json"
        if Path(old_file).exists():
            print(f"üìÅ Encontrado arquivo antigo: {old_file}")
            migrate = input("Migrar usu√°rios? (s/n): ").strip().lower()
            
            if migrate == 's':
                try:
                    with open(old_file, 'r') as f:
                        old_users = json.load(f)
                    
                    migrated = 0
                    for username, old_user in old_users.items():
                        if username not in manager.users:
                            # Converte formato antigo para novo
                            # Mapeia roles antigos para novos
                            role_mapping = {
                                "researcher": "Pesquisador",
                                "student": "Estudante", 
                                "professor": "Professor",
                                "admin": "Admin"
                            }
                            
                            old_role = old_user.get("role", "researcher")
                            new_role = role_mapping.get(old_role, "Pesquisador")
                            
                            new_user = {
                                "password_hash": old_user.get("password_hash", ""),
                                "name": old_user.get("name", username),
                                "role": new_role,
                                "organization": old_user.get("organization", ""),
                                "permissions": manager.role_permissions.get(new_role, []),
                                "created_at": old_user.get("created_at", datetime.now().isoformat()),
                                "last_login": old_user.get("last_login", ""),
                                "total_conversations": old_user.get("total_conversations", 0),
                                "successful_queries": 0,
                                "failed_queries": 0,
                                "extractions_count": 0,
                                "active": old_user.get("active", True),
                                "notes": f"Migrado de {old_file}"
                            }
                            
                            manager.users[username] = new_user
                            migrated += 1
                    
                    if manager.save_users():
                        print(f"‚úÖ {migrated} usu√°rios migrados com sucesso!")
                        
                        # Pergunta se quer fazer backup do arquivo antigo
                        backup = input("Fazer backup do arquivo antigo? (s/n): ").strip().lower()
                        if backup == 's':
                            backup_name = f"streamlit_users_backup_{datetime.now().strftime('%Y%m%d_%H%M%S')}.json"
                            shutil.copy2(old_file, backup_name)
                            print(f"üìÅ Backup criado: {backup_name}")
                    else:
                        print("‚ùå Erro ao salvar usu√°rios migrados!")
                        
                except Exception as e:
                    print(f"‚ùå Erro na migra√ß√£o: {e}")
        else:
            print(f"‚ÑπÔ∏è Arquivo antigo n√£o encontrado: {old_file}")

def main():
    """Fun√ß√£o principal"""
    manager = ProductionUserManager()
    
    # Cria usu√°rios padr√£o se n√£o existirem
    if not manager.users:
        print("üèóÔ∏è Criando usu√°rios padr√£o...")
        
        default_users = [
            ("admin", "Administrador", "admin123", "Admin", "Sistema"),
            ("pesquisador", "Dr. Pesquisador", "pesquisa123", "Pesquisador", "Universidade"),
            ("demo", "Usu√°rio Demo", "demo123", "Demonstra√ß√£o", "Demo")
        ]
        
        for username, name, password, role, org in default_users:
            success, message = manager.add_user(username, name, password, role, org)
            if success:
                print(f"‚úÖ {message}")
            else:
                print(f"‚ö†Ô∏è {message}")
    
    # Modo n√£o-interativo para automa√ß√£o
    if len(sys.argv) > 1:
        command = sys.argv[1]
        
        if command == "list":
            show_inactive = "--include-inactive" in sys.argv
            manager.list_users(show_inactive)
        
        elif command == "add" and len(sys.argv) >= 5:
            username, name, password = sys.argv[2:5]
            role = sys.argv[5] if len(sys.argv) > 5 else "Pesquisador"
            organization = sys.argv[6] if len(sys.argv) > 6 else ""
            
            success, message = manager.add_user(username, name, password, role, organization)
            print(message)
        
        elif command == "remove" and len(sys.argv) >= 3:
            username = sys.argv[2]
            success, message = manager.remove_user(username)
            print(message)
        
        elif command == "details" and len(sys.argv) >= 3:
            username = sys.argv[2]
            manager.get_user_details(username)
        
        elif command == "password" and len(sys.argv) >= 4:
            username, new_password = sys.argv[2:4]
            success, message = manager.update_user(username, password=new_password)
            print(message)
        
        elif command == "stats":
            show_statistics(manager)
        
        elif command == "backup":
            backup_file = f"production_users_backup_{datetime.now().strftime('%Y%m%d_%H%M%S')}.json"
            try:
                shutil.copy2(manager.users_file, backup_file)
                print(f"‚úÖ Backup criado: {backup_file}")
            except Exception as e:
                print(f"‚ùå Erro no backup: {e}")
        
        elif command == "help":
            print("üöÄ GERENCIADOR DE USU√ÅRIOS RAG PRODU√á√ÉO")
            print("\nComandos dispon√≠veis:")
            print("  list [--include-inactive]  - Lista usu√°rios")
            print("  add <user> <nome> <senha> [role] [org] - Adiciona usu√°rio")
            print("  remove <user>              - Remove usu√°rio")
            print("  details <user>             - Detalhes do usu√°rio")
            print("  password <user> <senha>    - Altera senha")
            print("  stats                      - Estat√≠sticas")
            print("  backup                     - Backup dos usu√°rios")
            print("  help                       - Esta ajuda")
            print("\nPerfis dispon√≠veis: Admin, Pesquisador, Demonstra√ß√£o, Estudante, Professor, Convidado")
            print("\nExemplos:")
            print("  python manage_production_users.py add joao 'Jo√£o Silva' senha123 Pesquisador 'UFMG'")
            print("  python manage_production_users.py list --include-inactive")
            print("  python manage_production_users.py details admin")
        
        else:
            print("‚ùå Comando inv√°lido! Use 'help' para ver comandos dispon√≠veis.")
        
        return
    
    # Modo interativo
    while True:
        show_menu()
        choice = input("\nEscolha uma op√ß√£o (1-10): ").strip()
        
        if choice == "1":
            add_user_interactive(manager)
        
        elif choice == "2":
            show_inactive = input("\nIncluir usu√°rios inativos? (s/n): ").strip().lower() == 's'
            manager.list_users(show_inactive)
        
        elif choice == "3":
            username = input("\nUsername para ver detalhes: ").strip()
            manager.get_user_details(username)
        
        elif choice == "4":
            edit_user_interactive(manager)
        
        elif choice == "5":
            change_password_interactive(manager)
        
        elif choice == "6":
            manage_permissions_interactive(manager)
        
        elif choice == "7":
            username = input("\nUsername para remover: ").strip()
            
            if username in manager.users:
                user_info = manager.users[username]
                print(f"\n‚ö†Ô∏è ATEN√á√ÉO: Voc√™ est√° prestes a remover:")
                print(f"   Usu√°rio: {username}")
                print(f"   Nome: {user_info['name']}")
                print(f"   Perfil: {user_info['role']}")
                print(f"   Organiza√ß√£o: {user_info.get('organization', 'N/A')}")
                
                confirm = input(f"\nPara confirmar, digite 'REMOVER {username}': ").strip()
                
                if confirm == f"REMOVER {username}":
                    success, message = manager.remove_user(username)
                    print(f"‚úÖ {message}" if success else f"‚ùå {message}")
                else:
                    print("‚ùå Remo√ß√£o cancelada.")
            else:
                print("‚ùå Usu√°rio n√£o encontrado!")
        
        elif choice == "8":
            show_statistics(manager)
        
        elif choice == "9":
            tools_menu(manager)
        
        elif choice == "10":
            print("\nüëã At√© logo!")
            print("üöÄ Sistema RAG de Produ√ß√£o - Usu√°rios gerenciados com sucesso!")
            break
        
        else:
            print("‚ùå Op√ß√£o inv√°lida!")
        
        input("\nPressione Enter para continuar...")

if __name__ == "__main__":
    try:
        main()
    except KeyboardInterrupt:
        print("\n\nüëã Opera√ß√£o cancelada pelo usu√°rio.")
    except Exception as e:
        print(f"\n‚ùå Erro cr√≠tico: {e}")
        sys.exit(1)